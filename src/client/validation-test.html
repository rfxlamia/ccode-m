<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Epic 1 Validation Test</title>
  <style>
    body { font-family: system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
    #chat-container { border: 1px solid #ddd; height: 400px; overflow-y: auto; padding: 16px; margin-bottom: 16px; background: #fafafa; }
    #chat-container .message { margin-bottom: 8px; padding: 8px 12px; border-radius: 6px; }
    #chat-container .user { background: #e3f2fd; margin-left: 20%; }
    #chat-container .claude { background: #f5f5f5; margin-right: 20%; }
    #input-area { display: flex; gap: 8px; }
    #message-input { flex: 1; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 6px; }
    #send-btn { padding: 12px 24px; background: #1976d2; color: white; border: none; border-radius: 6px; cursor: pointer; }
    #send-btn:disabled { background: #ccc; }
    #status { padding: 12px; background: #fff3cd; border-radius: 6px; margin-bottom: 16px; }
    #status.connected { background: #c8e6c9; }
    .error { color: #d32f2f; }
    .success { color: #388e3c; }
  </style>
</head>
<body>
  <h2>Epic 1 Infrastructure Validation</h2>
  
  <div id="status">Status: Connecting...</div>
  
  <div id="chat-container"></div>
  
  <div id="input-area">
    <input type="text" id="message-input" placeholder="Type a message to Claude..." />
    <button id="send-btn" disabled>Send</button>
  </div>

  <script>
    const chatContainer = document.getElementById('chat-container');
    const messageInput = document.getElementById('message-input');
    const sendBtn = document.getElementById('send-btn');
    const statusDiv = document.getElementById('status');
    
    let connected = false;
    
    // Simple SSE connection - will fail gracefully if endpoint doesn't exist
    function connectSSE() {
      try {
        const evtSource = new EventSource('/api/chat/stream/test-session');
        
        evtSource.onopen = () => {
          connected = true;
          statusDiv.textContent = 'Status: ✅ Connected to SSE';
          statusDiv.className = 'connected';
          sendBtn.disabled = false;
        };
        
        evtSource.onmessage = (e) => {
          addMessage('claude', e.data);
        };
        
        evtSource.onerror = (err) => {
          statusDiv.innerHTML = 'Status: ⚠️ SSE not available yet<br><small>Need to add /api/chat/stream endpoint</small>';
          connected = false;
          sendBtn.disabled = true;
          evtSource.close();
        };
      } catch (err) {
        statusDiv.innerHTML = `Status: ❌ Error: ${err.message}`;
      }
    }
    
    function addMessage(role, text) {
      const div = document.createElement('div');
      div.className = `message ${role}`;
      div.textContent = `${role === 'user' ? 'You' : 'Claude'}: ${text}`;
      chatContainer.appendChild(div);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    async function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;
      
      addMessage('user', text);
      messageInput.value = '';
      sendBtn.disabled = true;
      statusDiv.textContent = 'Status: Sending...';
      
      try {
        const response = await fetch('/api/chat/test-session', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text })
        });
        
        const data = await response.json();
        console.log('Response:', data);
        
        if (response.ok) {
          addMessage('claude', JSON.stringify(data));
          statusDiv.textContent = 'Status: ✅ Response received';
          statusDiv.className = 'connected';
        } else {
          addMessage('claude', `Error: ${data.error || response.statusText}`);
          statusDiv.textContent = 'Status: ⚠️ Error response';
        }
      } catch (err) {
        console.error('Error:', err);
        addMessage('claude', `Error: ${err.message}`);
        statusDiv.textContent = 'Status: ❌ Request failed';
      }
      
      sendBtn.disabled = false;
    }
    
    sendBtn.onclick = sendMessage;
    messageInput.onkeypress = (e) => e.key === 'Enter' && sendMessage();
    
    // Start connection
    connectSSE();
  </script>
</body>
</html>
